<script>
  var show_description = 0;
  var discount_schedules;
  var counters = new Array();
  counters['gizmo_event_line_id'] = <%= defined?(@lines) ? @lines.length : 0 %>;
  counters['payment_line_id'] = <%= defined?(@payment_lines) ? @payment_lines.length : 0 %>;
  counters['contact_method_line_id'] = <%= defined?(@contact_methods) ? @contact_methods.length : 0 %>;
  gizmo_context_name = '<%= @gizmo_context.name %>';
  coveredness_enabled = <%= coveredness_enabled.to_json %>;
</script>

<%= javascript_include_tag 'line_items' %>

<% if ["sales", "disbursements", "gizmo_returns"].include?(params[:controller]) %>
  <% js = "all_systems = new Array;" %>
  <% System.find(:all).each do |x| %>
    <% js += "all_systems[#{x.id}] = #{x.contract_id};" %>
  <% end %>
  <%= javascript_tag js %>
<% end %>

<% if ["sales"].include?(params[:controller]) %>
  <% js = "all_store_credits = new Array;" %>
  <% StoreCredit.find(:all).each do |x| %>
    <% js += "all_store_credits[#{x.id}] = #{x.amount_cents};" %>
  <% end %>
  <%= javascript_tag js %>
<% end %>

<% if ["sales", "donations", "recyclings", "disbursements", "gizmo_returns"].include?(params[:controller]) -%>
  <%= js = "var gizmo_types = new Array;"
      for gizmo_type in @gizmo_context.gizmo_types.sort_by(&:description)
        js += "gizmo_types[#{gizmo_type.id}] = '#{gizmo_type.description}';"
      end
      javascript_tag js %>
  <%= js = "var all_gizmo_types = new Array;"
      for gizmo_type in GizmoType.find(:all).sort_by(&:description)
        js += "all_gizmo_types[#{gizmo_type.id}] = '#{gizmo_type.description}';"
      end
      javascript_tag js %>
<% end -%>

<% if ["sales", "donations"].include?(params[:controller]) -%>
  <%= js = "var payment_methods = new Array;"
      for payment_method in PaymentMethod.find(:all).sort_by(&:description)
        js += "payment_methods[#{payment_method.id}] = '#{payment_method.description}';"
      end
      javascript_tag js %>
<% end -%>

<%= js = "var contact_method_types = new Array;"
    for contact_method_type in ContactMethodType.find(:all).sort_by(&:description)
      js += "contact_method_types[#{contact_method_type.id}] = '#{contact_method_type.description}';"
    end
    javascript_tag js %>

<%= if ["sales", "disbursements"].include?(params[:controller])
     js = "var all_contracts_names = new Array;"
     for contract in Contract.find(:all).sort_by(&:description)
       js += "all_contracts_names[#{contract.id}] = '#{contract.name}';"
     end
     javascript_tag js
    end
%>

<%= js = ""
      js += "var gizmo_types_covered = new Array;"
      for gizmo_type in GizmoType.find(:all)
        js += "gizmo_types_covered[#{gizmo_type.id}] = true;" if gizmo_type.covered
      end
      javascript_tag js
%>

<%=
   case params[:controller]
   when 'sales'
     js = "var discount_schedules = new Array;"
     gizmo_types = GizmoType.find(:all)
     for discount_schedule in DiscountSchedule.find(:all)
       js += "discount_schedules[#{discount_schedule.id}] = new Array;"
       for gizmo_type in gizmo_types
         js += "discount_schedules[#{discount_schedule.id}][#{gizmo_type.id}] = #{gizmo_type.multiplier_to_apply(discount_schedule, @transaction ? @transaction.occurred_at : DateTime.now)};"
       end
     end
     javascript_tag js
   when 'donations'
     js = "var fees = new Array();"
     fees = GizmoType.find(:all).map(){|x|
       "fees[#{x.id}]= new Array();" +
       "fees[#{x.id}]['required'] = #{x.required_fee_cents};" +
       "fees[#{x.id}]['suggested'] = #{x.suggested_fee_cents};"
     }
     js += fees.join()
     javascript_tag js
   when 'recyclings'
     js = "var all_contracts = new Array;"
     for contract in Contract.find(:all).sort_by(&:description)
       js += "all_contracts[#{contract.id}] = '#{contract.description}';"
     end
     javascript_tag js
   end
   %>

<%=
   if params[:controller] == 'sales' || params[:controller] == 'disbursements' || params[:controller] == 'gizmo_returns'
     system_types = GizmoType.find(:all, :conditions => ['gizmo_category_id = ?', GizmoCategory.find_by_name('system').id]).collect(&:id)
     javascript_tag "var system_types = new Array(#{system_types.join(', ')});"
   end
%>
