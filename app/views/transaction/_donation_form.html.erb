<% if Contract.find(:all).length > 1 %>
  <pre id="contract_notes" style="background: yellow">
  </pre>
<% end %>

<fieldset>
  <%= js = "contracts_notes = new Array();"
      Contract.find(:all).collect{|x| [x.id, x.notes]}.each{|x,y|
        js += "contracts_notes['#{x}'] = '#{escape_javascript(y)}';"
      }
     javascript_tag js %>

  <div class="row">
    <!--[form:donation]-->

    <div id="transaction_info">
      <div id="<%= contact_searchbox_id(@options) %>">
        <label for="donation_contact_type">What kind of contact?</label>
        <%= select_visibility( 'donation', 'contact_type',
                               :anonymous => render( :partial => 'anonymous' ),
                               :named => render( :partial => 'contact_search',
                                                 :locals => {:options => {
                                                     :on_display => "if($('contact__contract') && $('donation_contract_id')) {
                                              set_new_val($('donation_contract_id'),
                                                          parseInt($('contact__contract').innerHTML));
                                            }"
                                                   }}),
                               :dumped => render( :text => '' )) %>
      </div>

      <div class="form-extras">
        <% if Contract.find(:all).length > 1 %>
        <div class="form-element">
          <label for="donation_contract_id">Contract</label>
          <select id="donation_contract_id" name="donation[contract_id]" onChange="show_contract_notes();">
            <%= options_from_collection_for_select(Contract.find(:all), "id", "description", @donation.contract_id || Contract.find_by_name("default")) %>
          </select>
        </div>
        <%= javascript_tag "show_contract_notes()" %>
        <% end %>

        <div class="form-element">
          <label for="donation_comments">Comments</label>
          <%= text_area 'donation', 'comments' , {:cols => 20, :rows => 3, :class=>"text-input"} %>
        </div>
        <% if @donation.id and @donation.invoiced? %>
          <div class="form-element">
            <label for="donation_invoice_resolved_at">When was this invoice resolved?</label>
            <%= calendar_box 'donation', 'invoice_resolved_at',{},{:showOthers => true} %>
          </div>
        <% end %>
      </div>
    </div>

    <div id="transaction_line_items_div">
      <div id="donation_gizmos" class="datalist line_item">
        <%= render :partial => 'sale_gizmo_events' %>
      </div>

      <div id="donation_payments" class="datalist line_item">
        <%= render :partial => 'sale_payments' %>
      </div>

      <%= render :partial => 'donation_totals' %>

      <%= javascript_tag @gizmos_and_payments_js %>
    </div>

    <!--[eoform:donation]-->

  </div>
</fieldset>
