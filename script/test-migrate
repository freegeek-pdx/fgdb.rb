#!/bin/bash

set -e
set -x

export RAILS_ENV=development

TMP=$(mktemp -d /tmp/fgdb.testing.script.XXXXXXXXXX)
cd $TMP
scp -i ~/.ssh/scp_key tulip:/usr/local/arik/database.sql.gz ./
dropdb fgdb_$RAILS_ENV || true
gunzip database.sql.gz
sed -i "1,100 s/fgdb_production/fgdb_$RAILS_ENV/g" database.sql
psql < database.sql
if hostname -f | grep -q fglan; then
    git clone http://dev.freegeek.org/~ryan52/git/fgdb.rb trunk
else
    git clone git://git.freegeek.org/git/fgdb.rb trunk
fi
cd trunk
cp config/database.yml-example config/database.yml
ln -s /usr/share/rails vendor/rails
rake db:migrate
cd ../
rm -f database.sql
if [ "$1" != "--no-drop" ]; then
    dropdb fgdb_$RAILS_ENV
fi
rm -fr trunk
cd /
rm -fr $TMP
